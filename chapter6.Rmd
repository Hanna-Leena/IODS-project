---
author: "Hanna-Leena Kukkola"
title: "chapter6.Rmd"
output: html_document
---
## Week 6
This week we are going to do analysis for longitudinal data. First we are going to read the BPRS and RATS datasets.

```{r}
BPRS <- read.csv("BPRS.csv", header = TRUE, sep = ",")
```

```{r}
RATS <- read.csv("RATS.csv", header = TRUE, sep = ",")
```

## We are going to factor the categorial variables again.
```{r}
library(dplyr)
library(tidyr)
RATS$ID <- factor(RATS$ID)
RATS$Group <- factor(RATS$Group)

```

```{r}
#Next step: Convert the data sets to long form. 
#Add a Time variable to RATS.

RATSL <- RATS %>%
  gather(key = WD, value = Weight, -ID, -Group) %>%
  mutate(Time = as.integer(substr(WD,3,4)))
```

Let's draw a table of these datasets. 

```{r}
table(RATSL)
```

```{r}
names(RATS)
```
```{r}
names(RATSL)
```


##Implement the analyses of Chapter 8 of MABS using the RATS data. First we are going to do analysis for the RATS data.
To begin we shall plot the RATS values, differentiating between the treatment groups into which the rats have been randomized. This simple graph makes a number of features of the data readily apparent. 

```{r}
library(ggplot2)
```

```{r}
# Draw the plot
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "Weight (grams)") +
  theme(legend.position = "top")

ggplot(RATSL, aes(x = Time, y = Weight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(RATSL$Weight), max(RATSL$Weight)))
```

There are 3 different Groups. From this figure you can see the development of the weight of these rat groups during the almost 70 days period. You can see the individual response profiles by each rat in different groups.

### Next we are going to standardize the variables
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r}
RATSL <- RATSL %>%
  group_by(Time) %>%
  mutate(stdrats = (Weight - mean(Weight))/sd(Weight)) %>%
  ungroup()
```

##Let's glimpse at the data

```{r}
glimpse(RATSL)
```
Now you can see the standardised variable here in the data. So we succeeded on what we were trying to do.

Let's draw the plot again with the standardised variable.

```{r}
ggplot(RATSL, aes(x = Time, y = Weight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ Group, labeller = label_both) +
  scale_y_continuous(name = "stdrats")
```

Now here are the figures with standardised values of the weight. Nothing changed in these pictures.

#Now were are going to look at the number of weekdays

```{r}
n <- RATSL$Time %>% unique() %>% length()
```

#Next we are going to look at the summary data with mean and standard error of weight by group and time

```{r}
RATSS <- RATSL %>%
  group_by(Group, WD) %>%
  summarise(mean = mean(Weight), se = sd(Weight)/sqrt(n)) %>%
  ungroup()
```

```{r}
glimpse(RATSS)
```

##Next we are going to plot the mean profiles
```{r}
ggplot(RATSS, aes(x = WD, y = mean, linetype = "Time", shape = "Time")) +
  geom_line() +
  scale_linetype_manual(values = c(1,2)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2)) +
  geom_errorbar(aes(ymin = mean -se, ymax = mean +se, linetype = "1"), width=0.3) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(Weight) +/- se(Weight)")
```

KYSY MITÄ KANNATTAAA LAITTAA NÄIHIN COMBINE KOHTIIN???

#Create a summary data by weight and ID with mean as the summary variable (ignoring baseline weekday 0).

```{r}
RATSL8S <- RATSL %>%
  filter(WD >1) %>%
  group_by(Weight, Group) %>%
  summarise(mean = mean(Weight)) %>%
  ungroup() 
```

```{r}
glimpse(RATSL8S)
```

#Draw a boxplot 

```{r}
ggplot(RATSL8S, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight, weekdays 2 - 64")
```
ONKO TÄSSÄ JOKU ONGELMA????

#Create a new data by filtering the outlier and adjust the ggplot code the draw the plot again with the new data
```{r}
RATSL8S1 <- RATSL8S %>%
  filter(mean < 600)
```

Drawing the picture again

```{r}
ggplot(RATSL8S1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight, weekdays 2 - 64")
```

# Perfor a two-sample t-test

```{r}
names(RATSL8S1)
```
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```

MIKÄ ON VIKANA???
t.test(mean, Weight, data = RATSL8S1) -> en saa menemään läpi

# Add the baseline from the original data as a new variable to the summary data

EN YMMÄRRÄ, MIKÄ TÄSSÄ ON VIKANA????
RATSL8S2 <- RATSL8S %>%
  mutate(baseline = RATS$WD1) -> en saa menemään läpi


# Fit the linear model with the mean as the response

EN SAA TÄTÄ LÄPI fit <- lm(mean ~ baseline + Weight, data = RATSL8S2)


##Impelement the analyses of Chapter 9 of MABS using the BPRS data.

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r}
BPRS <- read.csv("BPRS.csv", header = TRUE, sep = ",")
```

```{r}
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)
#Add a week variable to BPRS 
BPRSL <-  BPRS %>% gather(key = weeks, value = bprs, -treatment, -subject)
```

```{r}
# Extract the week number
BPRSL <-  BPRSL %>% mutate(week = as.integer(substr(weeks,5,5)))
```

Let's look at the BPRSL data

```{r}
glimpse(BPRSL)
names(BPRSL)
```

```{R}
n <- BPRSL$week %>% unique() %>% length()
```

```{r}
names(BPRSL)
glimpse(BPRSL)
```



###Next we are going to draw a plot of the data.

```{r}
ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))
```

```{r}
ggplot(BPRSL, aes(x = week, y = bprs, group = subject)) +
  geom_line(aes(linetype = subject)) +
  scale_x_continuous(name = "Weeks", breaks = seq(0, 8)) +
  scale_y_continuous(name = "bprs") +
  theme(legend.position = "top")
```

##Create a regression model of BPRS_reg

```{r}
names(BPRS)
```
```{r}
names(BPRSL)
```

```{r}
library(tidyr)
library(dplyr)
library(lme4)
```

```{r}
BPRS_reg <- lm(bprs ~ weeks + subject, data = BPRSL)
```

# Print out a summary of the model
```{r}
summary(BPRS_reg)
```

#Access library lme
```{r}
library(lme4)
```

#Crete a random intercept model
```{r}
BPRS_ref <- lmer(bprs ~ weeks + treatment + (1 | subject  ), data = BPRSL, REML = FALSE)
```

#Summary of the model
```{r}
summary(BPRS_ref)
```

# create a random intercept and random slope model
```{r}
BPRS_ref1 <- lmer(bprs ~ weeks + treatment + (treatment | subject), data = BPRSL, REML = FALSE)
```

# print a summary of the model
```{r}
summary(BPRS_ref1)
```

# perform an ANOVA test on the two models
```{r}
anova(BPRS_ref1, BPRS_ref)
```

# create a random intercept and random slope model
```{r}
BPRS_ref2 <- lmer(bprs ~ weeks * treatment + (treatment | subject), data = BPRSL, REML = FALSE)
```

# print a summary of the model
```{r}
summary(BPRS_ref2)
```
MIKÄ VIKANA???

# perform an ANOVA test on the two models
```{r}
anova(BPRS_ref2, BPRS_ref1)
```


# draw the plot of BPRSL
```{r}
ggplot(BPRSL, aes(x = week, y = bprs, group = subject)) +
  geom_line(aes(linetype = subject)) +
  scale_x_continuous(name = "Weeks", breaks = seq(0, 8)) +
  scale_y_continuous(name = "bprs") +
  theme(legend.position = "top")
```


# Create a vector of the fitted values
```{r}
Fitted <- fitted(BPRS_ref2)
```

# Create a new column fitted to BPRSL
```{r}
BPRSL <- BPRSL %>%
  mutate(Fitted)
```

# draw the plot of BPRSL
```{r}
ggplot(BPRSL, aes(x = week, y = Fitted, group = subject)) +
  geom_line(aes(linetype = subject)) +
  scale_x_continuous(name = "Weeks", breaks = seq(0, 8)) +
  scale_y_continuous(name = "Fitted") +
  theme(legend.position = "top")
```


